[tools]
# --- ãƒ›ã‚¹ãƒˆãƒ»ã‚³ãƒ³ãƒ†ãƒŠå…±é€šã®ãƒ„ãƒ¼ãƒ«å®šç¾© ---
node = "20"
uv = "latest"
"npm:@devcontainers/cli" = "latest"
"npm:@anthropic-ai/claude-code" = "latest"
 
[tasks.dev]
description = "ãƒ›ã‚¹ãƒˆå´ï¼šä½¿ã„æ¨ã¦ç’°å¢ƒã‚’ç«‹ã¡ä¸Šã’ã‚‹"
run = """
#!/bin/bash

eval "$(mise activate bash)"

# 1. ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
export ISOLATED_WS=$(mktemp -d 2>/dev/null || mktemp -d -t 'dotfiles')
WS_NAME=$(basename "$ISOLATED_WS")

cp -r .config .devcontainer "$ISOLATED_WS/"

# 2. ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—äºˆç´„
trap 'rm -rf "$ISOLATED_WS"' EXIT INT TERM

# 3. ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
devcontainer up --workspace-folder "$ISOLATED_WS"
devcontainer exec --workspace-folder "$ISOLATED_WS" mise trust
devcontainer exec --workspace-folder "$ISOLATED_WS" mise run container-setup

# 4. ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚‹
devcontainer exec --workspace-folder "$ISOLATED_WS" bash
"""

[tasks.container-setup]
description = "ã‚³ãƒ³ãƒ†ãƒŠå´ï¼šmiseã‚’ä½¿ã£ã¦ãƒ„ãƒ¼ãƒ«ã‚’è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
run = """
#!/bin/bash

mise install -y

# gcloud CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (ä½¿ã„æ¨ã¦ç’°å¢ƒãªã®ã§ãƒã‚¤ãƒŠãƒªã‚’ç›´æ¥å…¥ã‚Œã‚‹æ–¹ãŒæ—©ã„)
if ! command -v gcloud &> /dev/null; then
    echo "ğŸ“¦ Installing gcloud CLI..."
    curl -sSL https://sdk.cloud.google.com | bash -s -- --disable-prompts --install-dir=$HOME > /dev/null
fi
export PATH="$HOME/google-cloud-sdk/bin:$PATH"

# æ°¸ç¶šåŒ–è¨­å®š (cat << 'EOF' ã‚’ä½¿ã£ã¦ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’ä¸è¦ã«ã™ã‚‹)
cat << 'EOF' >> ~/.bashrc

# --- mise setup ---
export PATH="$HOME/google-cloud-sdk/bin:$PATH"
eval "$(mise activate bash)"
EOF

source ~/.bashrc

# å„ç¨®èªè¨¼
gcloud auth login --no-launch-browser
gcloud auth application-default login --no-launch-browser
gh auth login
"""